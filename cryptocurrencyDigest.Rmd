---
title: "Cryptocurrency Digest"
author: "Eric Scheier"
date: "June 30, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE)
# load libraries
library(httr)
library(xts)
library(lubridate)
library(PerformanceAnalytics)
library(quantmod)
library(Quandl)
library(WDI)
library(reshape2)
library(ggplot2)
library(plyr)
library(corrplot)
#helper functions
getQuandlData <- function(symbol){
  start.date="2016-01-01"
  end.date="2016-06-29"
  Quandl(symbol, api_key="-GNvgv_nqBHeqiyEQjyj", start_date=start.date, end_date=end.date, type="xts")
}

getPoloniexData <- function(pair){
  start.seconds=as.numeric(seconds(as.POSIXct("2016-01-01", origin = "1970-01-01")))
  end.seconds=as.numeric(seconds(as.POSIXct("2016-06-29", origin = "1970-01-01")))
  new.data <- content(GET(paste0("https://poloniex.com/public?command=returnChartData&currencyPair="
                                     ,pair,"&start=",start.seconds,"&end=",end.seconds,"&period=86400")))
  new.data <- ldply(new.data, data.frame)
  new.data$date <- as.Date(as.POSIXct(new.data$date, origin = "1970-01-01"))
  xts.data <- xts(new.data[,"close"], order.by=new.data$date)
  names(xts.data) <- sub("BTC_","",pair)
  return(xts.data)
}
# load data
global.crypto <- content(GET("https://api.coinmarketcap.com/v1/global/"))

countries <- c('CN', 'US', 'EU', 'JP', 'IN')
mc <- WDI(indicator = 'NY.GDP.MKTP.KD',
          country = countries,
          start = 2014, end = 2014)
countries.long <- mc$country
```

The digital currency Bitcoin has become immensely popular over the past few years. Wild price swings, massive heists from online marketplaces, and the general concept of a nationless, cryptography-based currency have captured the minds of many.

But what do the numbers actually say? And what about more recently introduced digital currencies such as Etherium and Ripple?

## Cryptos in Context

Let’s start by putting digital currencies in context with the global economy and parts of the financial system.

First, we can look at the market capitalization of cryptocurrencies compared to the Gross Domestic Products (GDPs) of some major countries:

```{r}
crypto.market.cap <- global.crypto$total_market_cap_usd
crypto.trading.vol <- global.crypto$total_24h_volume_usd

market.stats <- data.frame(market=c("Cryptos", countries.long),
                           gdp=c(crypto.market.cap, mc$NY.GDP.MKTP.KD))

ggplot(data=market.stats, aes(x=market, y=gdp, fill=market)) +
  geom_bar(colour="black", stat="identity") +
  guides(fill=FALSE) + scale_y_log10(name="Log(USD)")
```

So, cryptocurrencies are pretty large, but a few orders of magnitude away from being a global player.

Next, let’s get a sense of just how volatile Bitcoin (or BTC, for short) has been by comparing its daily changes in price over the year so far with some popularly traded assets. We’ll use the S&P500 and Russell2000 to represent stocks, and the USD/GBP, USD/EUR, and USD/JPY currency pairs as other currencies for our benchmarks.

```{r}
# then return profiles
price.history <- list(
  USDBTC = getQuandlData("BCHARTS/COINBASEUSD")[,"Weighted Price"],
  SPY = getQuandlData("YAHOO/INDEX_SPY")[,"Adjusted Close"],
  DOW = getQuandlData("YAHOO/INDEX_DJI")[,"Adjusted Close"],
  R2000 = getQuandlData("YAHOO/INDEX_RUT")[,"Adjusted Close"],
  USDGBP = getQuandlData("BUNDESBANK/BBEX3_D_USD_GBP_CA_AC_000"), #USD/GBP
  USDEUR = getQuandlData("BOE/XUDLERD"), #USD/EUR
  JPYUSD = getQuandlData("BUNDESBANK/BBEX3_D_JPY_USD_CA_AC_000")
)
list.names <- names(price.history)
price.history <- do.call(merge, price.history)
names(price.history) <- list.names
# fix a known mistake point by removing it
price.history["2016-03-22","USDGBP"] <- NA

combined.price.history <- na.fill(CalculateReturns(price.history), fill=0)

# Green as highlight
greenfocus = c("#41AB5D", "#252525", "#525252", "#737373", "#969696", "#BDBDBD", "#D9D9D9", "#F0F0F0")
chart.CumReturns(combined.price.history, legend.loc = "topleft", colorset = greenfocus,
                 main="Cumulative Returns of BTC/USD vs. other assets for 2016")
```

Wow, pretty volatile huh? As we can see, even at their most stormy the major indeces of the US and UK were but calm ponds compared to the tsunami of BTC. Even Britain’s recent currency volatility surrounding Brexit looks rather tame by comparison. And how closely correlated are the movements in BTC to those of our basket? Not very:

```{r}
corrplot(cor(combined.price.history), type="lower", order="hclust", tl.col="black", tl.srt=45)
```

## Comparing Apples to Apples

While digital currencies remain volatile, the market caps and trading volumes of these assets suggest that the asset class is maturing. It’s certainly too big to ignore. Let’s take a look at how the most widely traded cryptocurrencies have evolved over the past year.

There are dozens of digital currencies that can be traded on Poloniex, a major exchange based in the U.S. Frankly, most of them are of questionable utility. We’ll focus on the 11 for which “margin trading” is allowed, meaning that traders borrow and lend the currencies in the marketplace in addition to simply trading them. In general these are the most mature digital currencies around, which is why traders and exchanges are comfortable borrowing, lending, and using them as collateral.

The prices below are all in terms of how much of that currency can be purchased with BTC. We are no longer in the world of government-backed currency!

```{r}
# load and combine price data
margin.pairs <- c("BTC_BTS", "BTC_CLAM", "BTC_DASH", "BTC_DOGE", "BTC_ETH", "BTC_FCT"
                       , "BTC_LTC", "BTC_MAID", "BTC_STR", "BTC_XMR", "BTC_XRP")

pairs <- c("USDT_BTC","USDT_ETH", "USDT_DASH", "USDT_LTC", "USDT_NXT", "USDT_STR", "USDT_XMR", "USDT_XRP")
poloniex.data <- do.call(merge, lapply(pairs, getPoloniexData))

polo.returns <- na.omit(Return.calculate(poloniex.data))
tol11qualitative=c("#332288", "#6699CC", "#88CCEE", "#44AA99", "#117733", "#999933", "#DDCC77", "#661100", "#CC6677", "#882255", "#AA4499")

chart.CumReturns(polo.returns, legend.loc = "topleft", colorset = tol11qualitative,
                 main="Cumulative Returns of Margin Traded Assets on Poloniex")

```

So, even normalized to returns there is a lot of noise in this dataset. ETH and MAID have been made some big moves upward this year against BTC, while the other currencies have been floating around each other. Let's see how correlated they've all been, first in detail and then using a broader graph that our brains can iterpret more easily.

```{r}
chart.Correlation(polo.returns)
corrplot(cor(polo.returns), type="lower", order="hclust", tl.col="black", tl.srt=45)
```

As we can see, these assets are slightly positively correlated with each other. However, let's look at how they interact with the USDBTC pair. That is, when the amount of USD that can be purchased with one BTC rises, what happens to these currencies?

```{r}
corrplot(cor(na.omit(merge(polo.returns, combined.price.history$USDBTC))), type="lower", order="hclust", tl.col="black", tl.srt=45)
```

Wow, very inversely correlated. So when the "price" of BTC (most folks quoting the price are using the USDBTC pair) goes up, most other cryptocurrencies go down. When the amount of BTC that can be bough with 1 USD goes up, most other cryptocurrencies go up. This intuitively makes some sense, since the market is based on BTC in the first place.

Hopefully this brief introduction to cryptocurrencies has given you some insights into the size of the market and how the assets have been acting this year.